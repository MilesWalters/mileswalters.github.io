<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polynomial Fit & Derivatives Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #drawingCanvas {
            border: 2px solid #3b82f6;
            cursor: crosshair;
            touch-action: none;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            background-color: #f9fafb;
        }
        .container-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4 font-sans">

    <div class="w-full max-w-5xl bg-white p-8 rounded-2xl container-shadow">
        <h1 class="text-4xl font-extrabold text-center text-gray-800 mb-2">Function & Derivative Plot for Portfolio 2</h1>
        <p class="text-center text-gray-600 mb-8">Draw a curve below, then click 'Fit & Plot' to find the best-fit cubic polynomial (f(x)) and visualize its first (f'(x)) and second (f''(x)) derivatives.</p>

        <div class="flex flex-col lg:flex-row gap-8">
            
            <div class="lg:w-3/5 w-full">
                <canvas id="drawingCanvas" width="600" height="350"></canvas>
            </div>

            <div class="lg:w-2/5 w-full flex flex-col justify-start space-y-4">
                <button onclick="clearCanvasAndData()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition duration-150 shadow-lg hover:shadow-xl transform hover:scale-[1.01]">
                    <span class="text-lg">Clear All</span>
                </button>
                <button onclick="performRegressionAndDraw()" id="plotButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl transition duration-150 shadow-lg hover:shadow-xl transform hover:scale-[1.01]">
                    <span class="text-lg">Fit & Plot Derivatives</span>
                </button>
                
                <div class="bg-blue-50 border border-blue-200 p-4 rounded-xl shadow-inner">
                    <h3 class="font-bold text-blue-800 mb-2">Fitted Polynomial (f(x))</h3>
                    <p id="formulaF" class="text-sm text-blue-700 font-mono break-words"></p>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-xl shadow-inner">
                    <h3 class="font-bold text-yellow-800 mb-2">First Derivative (f'(x))</h3>
                    <p id="formulaFPrime" class="text-sm text-yellow-700 font-mono break-words"></p>
                </div>
                <div class="bg-purple-50 border border-purple-200 p-4 rounded-xl shadow-inner">
                    <h3 class="font-bold text-purple-800 mb-2">Second Derivative (f''(x))</h3>
                    <p id="formulaFDoublePrime" class="text-sm text-purple-700 font-mono break-words"></p>
                </div>
            </div>
        </div>

        <div class="mt-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">Legend:</h3>
            <ul class="list-none grid grid-cols-2 sm:grid-cols-4 gap-4 text-gray-600">
                <li class="flex items-center"><span class="inline-block w-4 h-4 rounded-full mr-2" style="background-color: #ef4444;"></span> Drawn</li>
                <li class="flex items-center"><span class="inline-block w-4 h-1 mr-2 rounded" style="background-color: #3b82f6;"></span> Fit Function f(x)</li>
                <li class="flex items-center"><span class="inline-block w-4 h-1 mr-2 rounded" style="background-color: #f59e0b;"></span> First Derivative f'(x)</li>
                <li class="flex items-center"><span class="inline-block w-4 h-1 mr-2 rounded" style="background-color: #9333ea;"></span> Second Derivative f''(x)</li>
            </ul>
        </div>
    </div>

    <script type="text/javascript">
        const CANVAS_ID = 'drawingCanvas';
        const DEGREE = 3;
        
        const MATH_X_MIN = -5;
        const MATH_X_MAX = 5;

        let currentMathYMin = -5;
        let currentMathYMax = 5;

        const COEFFICIENT_TOLERANCE = 1e-4; 
        

        let canvas, ctx;
        let points = [];
        let isDrawing = false;
        let polynomialCoefficients = null;

        document.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById(CANVAS_ID);
            ctx = canvas.getContext('2d');
            
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startDrawing(e.touches[0]);
            });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                draw(e.touches[0]);
            });

            clearCanvasAndData(false); 
        });

        function canvasToMathX(cx) {
            return MATH_X_MIN + (cx / canvas.width) * (MATH_X_MAX - MATH_X_MIN);
        }

        function canvasToMathY(cy) {
            const DEFAULT_Y_MIN = -5;
            const DEFAULT_Y_MAX = 5;
            return DEFAULT_Y_MAX - (cy / canvas.height) * (DEFAULT_Y_MAX - DEFAULT_Y_MIN);
        }

        function mathToCanvasX(mx) {
            return ((mx - MATH_X_MIN) / (MATH_X_MAX - MATH_X_MIN)) * canvas.width;
        }

        function mathToCanvasY_Dynamic(my) {
            return canvas.height - ((my - currentMathYMin) / (currentMathYMax - currentMathYMin)) * canvas.height;
        }


        function getRelativeCoords(e) {
            if (e.offsetX !== undefined && e.offsetY !== undefined) {
                return { cx: e.offsetX, cy: e.offsetY };
            }

            const rect = canvas.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;
            return { cx, cy };
        }

        function startDrawing(e) {
            isDrawing = true;
            const { cx, cy } = getRelativeCoords(e);
            addPoint(cx, cy);
            
            ctx.beginPath();
            ctx.moveTo(cx, cy);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        function draw(e) {
            if (!isDrawing) return;
            const { cx, cy } = getRelativeCoords(e);

            ctx.lineTo(cx, cy);
            ctx.strokeStyle = '#ef4444';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(cx, cy);

            addPoint(cx, cy);
        }

        function addPoint(cx, cy) {
            if (!canvas) return;
            
            const mx = canvasToMathX(cx);
            const my = canvasToMathY(cy);
            
            if (points.length === 0 || Math.hypot(points[points.length - 1].mx - mx) > 0.05) {
                 points.push({ mx, my });
            }
        }

        function clearCanvasAndData(resetCoefficients = true) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            points = [];
            
            currentMathYMin = -5;
            currentMathYMax = 5;
            
            if (resetCoefficients) {
                polynomialCoefficients = null;
                document.getElementById('formulaF').textContent = '';
                document.getElementById('formulaFPrime').textContent = '';
                document.getElementById('formulaFDoublePrime').textContent = '';
            }
            
            drawAxes();
        }

        function drawAxes() {
            ctx.save();
            ctx.strokeStyle = '#cccccc';
            ctx.lineWidth = 1;
            ctx.setLineDash([5, 5]);

            const cyZero = mathToCanvasY_Dynamic(0);
            if (cyZero >= 0 && cyZero <= canvas.height) {
                ctx.beginPath();
                ctx.moveTo(0, cyZero);
                ctx.lineTo(canvas.width, cyZero);
                ctx.stroke();
            }

            const cxZero = mathToCanvasX(0);
            if (cxZero >= 0 && cxZero <= canvas.width) {
                ctx.beginPath();
                ctx.moveTo(cxZero, 0);
                ctx.lineTo(cxZero, canvas.height);
                ctx.stroke();
            }

            ctx.setLineDash([]);
            ctx.restore();
        }

        function drawGraph(func, color, lineWidth = 2) {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = lineWidth;

            for (let i = 0; i <= canvas.width; i += 1) {
                const mx = canvasToMathX(i);
                const my = func(mx);
                const cy = mathToCanvasY_Dynamic(my);

                if (cy >= -100 && cy <= canvas.height + 100) { 
                    if (i === 0) {
                        ctx.moveTo(i, cy);
                    } else {
                        ctx.lineTo(i, cy);
                    }
                } else {
                    ctx.moveTo(i, cy);
                }
            }
            ctx.stroke();
        }

        function drawDataPoints() {
            ctx.fillStyle = '#ef4444';
            points.forEach(p => {
                const cx = mathToCanvasX(p.mx);
                const cy = mathToCanvasY_Dynamic(p.my);
                
                ctx.beginPath();
                ctx.arc(cx, cy, 2, 0, Math.PI * 2); 
                ctx.fill();
            });
        }

        function calculateAutoZoomBounds(f, fPrime, fDoublePrime) {
            let allYValues = [];
            
            points.forEach(p => allYValues.push(p.my));
            
            for (let i = 0; i <= canvas.width; i += 10) {
                const mx = canvasToMathX(i);
                allYValues.push(f(mx));
                allYValues.push(fPrime(mx));
                allYValues.push(fDoublePrime(mx));
            }
            
            if (allYValues.length === 0) return;

            let minY = Math.min(...allYValues);
            let maxY = Math.max(...allYValues);

            const range = maxY - minY;
            const padding = (range > 0) ? range * 0.2 : 2;
            
            currentMathYMin = minY - padding;
            currentMathYMax = maxY + padding;
        }
        
        function solveSystem(A, B) {
            const n = B.length;
            const matrix = [];
            for (let i = 0; i < n; i++) {
                matrix[i] = [...A[i], B[i]];
            }

            for (let i = 0; i < n; i++) {
                let maxRow = i;
                for (let k = i + 1; k < n; k++) {
                    if (Math.abs(matrix[k][i]) > Math.abs(matrix[maxRow][i])) {
                        maxRow = k;
                    }
                }
                [matrix[i], matrix[maxRow]] = [matrix[maxRow], matrix[i]];

                const divisor = matrix[i][i];
                if (Math.abs(divisor) < 1e-9) { 
                    console.error("Matrix is singular or ill-conditioned. Cannot find unique solution.");
                    return null; 
                }
                for (let j = i; j < n + 1; j++) {
                    matrix[i][j] /= divisor;
                }

                for (let k = 0; k < n; k++) {
                    if (k !== i) {
                        const factor = matrix[k][i];
                        for (let j = i; j < n + 1; j++) {
                            matrix[k][j] -= factor * matrix[i][j];
                        }
                    }
                }
            }

            return matrix.map(row => row[n]);
        }


        function performRegression() {
            if (points.length < DEGREE + 1) {
                console.warn(`Need at least ${DEGREE + 1} points for a degree ${DEGREE} fit.`);
                return null;
            }

            const n = DEGREE + 1; 
            
            const sumXPowers = new Array(2 * DEGREE + 1).fill(0); 
            const sumYXPowers = new Array(DEGREE + 1).fill(0);    

            points.forEach(p => {
                for (let k = 0; k <= 2 * DEGREE; k++) {
                    sumXPowers[k] += Math.pow(p.mx, k);
                }
                for (let k = 0; k <= DEGREE; k++) {
                    sumYXPowers[k] += p.my * Math.pow(p.mx, k);
                }
            });

            const A = []; 
            const B = sumYXPowers; 

            for (let i = 0; i < n; i++) {
                A[i] = [];
                for (let j = 0; j < n; j++) {
                    A[i][j] = sumXPowers[i + j];
                }
            }

            const coefficients = solveSystem(A, B);
            
            if (coefficients) {
                return coefficients.reverse(); 
            }
            return null;
        }

        function getPolynomialFunc(coeffs) {
            return (x) => {
                return coeffs.reduce((sum, coeff, i) => sum + coeff * Math.pow(x, coeffs.length - 1 - i), 0);
            };
        }

        function calculateDerivativeCoeffs(coeffs, order) {
            let derivativeCoeffs = [...coeffs];
            
            for (let k = 0; k < order; k++) {
                let newCoeffs = [];
                for (let i = 1; i < derivativeCoeffs.length; i++) {
                    const originalPower = derivativeCoeffs.length - 1 - i;
                    const newCoeff = derivativeCoeffs[i] * originalPower;
                    newCoeffs.push(newCoeff);
                }
                derivativeCoeffs = newCoeffs.reverse();
            }
            
            return derivativeCoeffs;
        }

        function formatPolynomial(coeffs, degreeOffset = 0) {
            if (!coeffs || coeffs.length === 0) return '0.0000';
            
            const terms = [];
            
            for (let i = 0; i < coeffs.length; i++) {
                const coeff = coeffs[i];
                const power = coeffs.length - 1 - i + degreeOffset;

                if (Math.abs(coeff) < COEFFICIENT_TOLERANCE) continue;

                const absCoeff = Math.abs(coeff);
                let termStr = absCoeff.toFixed(4);
                
                if (power === 1) {
                    termStr += 'x';
                } else if (power > 1) {
                    termStr += 'x^' + power;
                }

                if (terms.length === 0) {
                    if (coeff < 0) termStr = '-' + termStr;
                } else {
                    termStr = (coeff < 0 ? ' - ' : ' + ') + termStr;
                }
                
                terms.push(termStr);
            }

            if (terms.length === 0) return '0.0000';
            return terms.join(' ').trim();
        }


        function performRegressionAndDraw() {
            if (points.length < DEGREE + 1) {
                alert(`Please draw a function with at least ${DEGREE + 1} points before calculating the fit. (You currently have ${points.length} points.)`);
                return;
            }
            
            const coeffs = performRegression(); 
            if (!coeffs) return; 
            polynomialCoefficients = coeffs;

            const fPrimeCoeffs = calculateDerivativeCoeffs(coeffs, 1);
            const fDoublePrimeCoeffs = calculateDerivativeCoeffs(coeffs, 2);

            const f = getPolynomialFunc(coeffs);
            const fPrime = getPolynomialFunc(fPrimeCoeffs);
            const fDoublePrime = getPolynomialFunc(fDoublePrimeCoeffs);
            
            calculateAutoZoomBounds(f, fPrime, fDoublePrime);

            clearCanvasAndData(false); 

            document.getElementById('formulaF').textContent = formatPolynomial(coeffs, 0); 
            document.getElementById('formulaFPrime').textContent = formatPolynomial(fPrimeCoeffs, 0); 
            document.getElementById('formulaFDoublePrime').textContent = formatPolynomial(fDoublePrimeCoeffs, 0); 

            drawDataPoints();
            drawGraph(f, '#3b82f6', 3);      
            drawGraph(fPrime, '#f59e0b', 2);  
            drawGraph(fDoublePrime, '#9333ea', 2); 
        }

    </script>
</body>
</html>
