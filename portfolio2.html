<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exploration for Portfolio 2 - Miles Walters</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { font-family: 'Roboto', sans-serif; }
        canvas { touch-action: none; cursor: crosshair; border: 1px solid #e5e7eb; }
        .info-box-hidden { display: none; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl space-y-6">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">
            Draw a quadratic to see its derivatives
        </h1>
        <p class="text-center text-sm text-gray-600">
            Click and drag (draw!) on the canvas to define a set of points. The best-fit parabola will appear.
        </p>

        <div class="flex flex-col md:flex-row bg-white p-6 rounded-xl shadow-2xl">
            <div class="w-full md:w-3/4 relative">
                <canvas id="graphCanvas" class="w-full h-96 rounded-lg"></canvas>
                <div id="statusMessage" class="absolute top-2 left-2 px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-lg shadow">
                    Start drawing your curve!
                </div>
            </div>

            <div id="statsContainer" class="w-full md:w-1/4 md:pl-6 pt-4 md:pt-0">
                <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-1">Coefficients</h2>
                <div id="coefficients" class="text-sm font-mono space-y-1">
                    <p><span class="font-medium text-gray-600">a:</span> <span id="coeffA">Draw something first!</span></p>
                    <p><span class="font-medium text-gray-600">b:</span> <span id="coeffB">Draw something first!</span></p>
                    <p><span class="font-medium text-gray-600">c:</span> <span id="coeffC">Draw something first!</span></p>
                </div>

                <h2 class="text-lg font-bold text-gray-800 mt-4 mb-3 border-b pb-1">Statistics</h2>
                <div id="statistics" class="text-sm font-mono space-y-1 mb-4">
                    <p><span class="font-medium text-gray-600">RÂ²:</span> <span id="rSquared">N/A</span></p>
                </div>

                <div id="hoverStats" class="text-xs font-mono bg-gray-50 p-3 rounded-lg border">
                    <p class="text-gray-500 mb-2">Hover over the graph to see values.</p>
                    <p><span class="font-medium text-gray-600">X:</span> <span id="statX">0.00</span></p>
                    <p><span class="font-medium text-gray-600">f(X):</span> <span id="statFX">0.00</span> (Fit line, Red)</p>
                    <p><span class="font-medium text-gray-600">f'(X):</span> <span id="statF1X">0.00</span> (1st Deriv., Blue)</p>
                    <p><span class="font-medium text-gray-600">f''(X):</span> <span id="statF2X">0.00</span> (2nd Deriv., Green)</p>
                </div>
            </div>
        </div>

        <button id="resetButton" class="w-full py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-xl shadow-lg transition duration-150">
            Clear Drawing
        </button>

    </div>

    <script>
        const canvas = document.getElementById('graphCanvas');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('statusMessage');
        const coeffAEl = document.getElementById('coeffA');
        const coeffBEl = document.getElementById('coeffB');
        const coeffCEl = document.getElementById('coeffC');
        const rSquaredEl = document.getElementById('rSquared'); 
        const statXEl = document.getElementById('statX');
        const statFXEl = document.getElementById('statFX');
        const statF1XEl = document.getElementById('statF1X');
        const statF2XEl = document.getElementById('statF2X');
        const resetButton = document.getElementById('resetButton');

        let points = [];
        let coeffs = { a: 0, b: 0, c: 0, rSquared: 0 }; 
        let scale = 20;
        let isDrawing = false;

        function resizeCanvas() {
            const rect = canvas.parentNode.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 400;
            drawGraph();
        }

        function toGraphX(x) {
            return (x - canvas.width / 2) / scale;
        }

        function toGraphY(y) {
            return -(y - canvas.height / 2) / scale;
        }

        function toCanvasX(x) {
            return x * scale + canvas.width / 2;
        }

        function toCanvasY(y) {
            return -y * scale + canvas.height / 2;
        }

        function f(x, c) {
            return c.a * x * x + c.b * x + c.c;
        }

        function f1(x, c) {
            return 2 * c.a * x + c.b;
        }

        function f2(x, c) {
            return 2 * c.a;
        }

        function fitCurve(points) {
            if (points.length < 3) return null;

            let Sxx4 = 0, Sxx3 = 0, Sxx2 = 0, Sxx = 0;
            let Sxy2 = 0, Sxy = 0, Sy = 0;
            const N = points.length;

            for (const p of points) {
                const x = p.x;
                const y = p.y;
                const x2 = x * x;
                const x3 = x * x2;
                const x4 = x * x3;

                Sxx4 += x4;
                Sxx3 += x3;
                Sxx2 += x2;
                Sxx += x;

                Sxy2 += x2 * y;
                Sxy += x * y;
                Sy += y;
            }

            const M = [
                [Sxx4, Sxx3, Sxx2],
                [Sxx3, Sxx2, Sxx],
                [Sxx2, Sxx, N]
            ];

            const V = [Sxy2, Sxy, Sy];

            const A = [
                [M[0][0], M[0][1], M[0][2], V[0]],
                [M[1][0], M[1][1], M[1][2], V[1]],
                [M[2][0], M[2][1], M[2][2], V[2]]
            ];

            const size = 3;

            
            for (let i = 0; i < size; i++) {
                let pivot = A[i][i];
                if (Math.abs(pivot) < 1e-9) return null; 
                for (let j = i + 1; j < size; j++) {
                    const factor = A[j][i] / A[i][i];
                    for (let k = i; k < size + 1; k++) {
                        A[j][k] -= factor * A[i][k];
                    }
                }
            }

            const result = new Array(size);
            for (let i = size - 1; i >= 0; i--) {
                let sum = 0;
                for (let j = i + 1; j < size; j++) {
                    sum += A[i][j] * result[j];
                }
                result[i] = (A[i][size] - sum) / A[i][i];
            }

            const fittedCoeffs = { a: result[0], b: result[1], c: result[2] };

            let sumY = 0;
            for (const p of points) {
                sumY += p.y;
            }
            const meanY = sumY / N;

            let SStot = 0; 
            let SSres = 0; 

            for (const p of points) {
                const fittedY = f(p.x, fittedCoeffs);
                const residual = p.y - fittedY;
                const totalVariation = p.y - meanY;
                
                SStot += totalVariation * totalVariation;
                SSres += residual * residual;
            }

            let rSquared = 0;
            if (SStot > 1e-9) { 
                rSquared = 1 - (SSres / SStot);
            }
            
            rSquared = Math.min(1.0, rSquared); 

            return { ...fittedCoeffs, rSquared: rSquared };
        }

        function drawGraph() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Grid
            ctx.beginPath();
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 1;
            for (let i = -canvas.width / 2; i < canvas.width / 2; i += scale) {
                ctx.moveTo(i + canvas.width / 2, 0);
                ctx.lineTo(i + canvas.width / 2, canvas.height);
            }
            for (let i = -canvas.height / 2; i < canvas.height / 2; i += scale) {
                ctx.moveTo(0, i + canvas.height / 2);
                ctx.lineTo(canvas.width, i + canvas.height / 2);
            }
            ctx.stroke();

            // Draw Axes
            ctx.beginPath();
            ctx.strokeStyle = '#4b5563';
            ctx.lineWidth = 2;
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();

            // Draw user-drawn points
            if (points.length > 0) {
                ctx.beginPath();
                ctx.strokeStyle = '#9ca3af';
                ctx.lineWidth = 1;
                ctx.moveTo(toCanvasX(points[0].x), toCanvasY(points[0].y));
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(toCanvasX(points[i].x), toCanvasY(points[i].y));
                }
                ctx.stroke();
            }

            function plot(func, color) {
                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;

                let first = true;
                const step = 0.5;

                for (let px = 0; px <= canvas.width; px += step) {
                    const x = toGraphX(px);
                    const y = func(x, coeffs);
                    const py = toCanvasY(y);

                    if (first) {
                        ctx.moveTo(px, py);
                        first = false;
                    } else {
                        ctx.lineTo(px, py);
                    }
                }
                ctx.stroke();
            }

            if (points.length >= 3) {
                plot(f, '#ef4444'); 
                plot(f1, '#3b82f6'); 
                plot(f2, '#10b981'); 
            }
        }

        function updateCoefficients() {
            if (points.length >= 3) {
                const fitResult = fitCurve(points);
                if (fitResult && !isNaN(fitResult.a)) {
                    coeffs = fitResult;
                    coeffAEl.textContent = coeffs.a.toFixed(4);
                    coeffBEl.textContent = coeffs.b.toFixed(4);
                    coeffCEl.textContent = coeffs.c.toFixed(4);
                    rSquaredEl.textContent = coeffs.rSquared.toFixed(4); 

                    statusEl.textContent = `Fitted curve to ${points.length} points! RÂ²: ${coeffs.rSquared.toFixed(3)}`;
                    statusEl.classList.remove('bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800');
                    statusEl.classList.add('bg-green-100', 'text-green-800');
                } else {
                    coeffAEl.textContent = 'N/A (Error)';
                    coeffBEl.textContent = 'N/A (Error)';
                    coeffCEl.textContent = 'N/A (Error)';
                    rSquaredEl.textContent = 'N/A';
                    coeffs = { a: 0, b: 0, c: 0, rSquared: 0 };
                    statusEl.textContent = 'Cannot fit curve (Math Error or Collinear points).';
                    statusEl.classList.remove('bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800', 'bg-green-100', 'text-green-800');
                    statusEl.classList.add('bg-red-100', 'text-red-800');
                }
            } else {
                coeffAEl.textContent = 'N/A';
                coeffBEl.textContent = 'N/A';
                coeffCEl.textContent = 'N/A';
                rSquaredEl.textContent = 'N/A'; 
                coeffs = { a: 0, b: 0, c: 0, rSquared: 0 };
                statusEl.textContent = 'Draw more than 3 points to fit a curve.';
                statusEl.classList.remove('bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800');
                statusEl.classList.add('bg-blue-100');
            }
        }

        function getCoords(event) {
            const rect = canvas.getBoundingClientRect();
            const clientX = event.clientX || (event.touches ? event.touches[0].clientX : null);
            const clientY = event.clientY || (event.touches ? event.touches[0].clientY : null);

            if (clientX === null || clientY === null) return null;

            const canvasX = clientX - rect.left;
            const canvasY = clientY - rect.top;

            return { canvasX, canvasY, x: toGraphX(canvasX), y: toGraphY(canvasY) };
        }

        function handlePointerDown(event) {
            const coords = getCoords(event);
            if (!coords) return;

            isDrawing = true;
            points = [];
            statusEl.textContent = 'Drawing... Release to fit curve.';
            statusEl.classList.remove('bg-blue-100', 'text-blue-800', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800');
            statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
            canvas.style.cursor = 'crosshair';
            handlePointerMove(event);
        }

        function handlePointerMove(event) {
            const coords = getCoords(event);
            if (!coords) return;

            if (isDrawing) {
                event.preventDefault();
                points.push({ x: coords.x, y: coords.y });
                drawGraph();
                return;
            }

            const x = coords.x;
            const fx = f(x, coeffs);
            const f1x = f1(x, coeffs);
            const f2x = f2(x, coeffs);

            statXEl.textContent = x.toFixed(3);
            statFXEl.textContent = fx.toFixed(3);
            statF1XEl.textContent = f1x.toFixed(3);
            statF2XEl.textContent = f2x.toFixed(3);

            if (points.length >= 3) {
                drawGraph();

                ctx.beginPath();
                ctx.strokeStyle = '#4b5563';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.moveTo(coords.canvasX, 0);
                ctx.lineTo(coords.canvasX, canvas.height);
                ctx.stroke();
                ctx.setLineDash([]);
            }
        }

        function handlePointerUp() {
            if (isDrawing) {
                isDrawing = false;
                canvas.style.cursor = 'crosshair';
                updateCoefficients();
                drawGraph();
            }
        }

        function handleReset() {
            points = [];
            statusEl.textContent = 'Start drawing your curve!';
            statusEl.classList.remove('bg-green-100', 'text-green-800', 'bg-yellow-100', 'text-yellow-800', 'bg-red-100', 'text-red-800');
            statusEl.classList.add('bg-blue-100', 'text-blue-800');
            updateCoefficients();
            drawGraph();
        }

        window.addEventListener('resize', resizeCanvas);
        canvas.addEventListener('mousedown', handlePointerDown);
        canvas.addEventListener('touchstart', handlePointerDown);
        canvas.addEventListener('mousemove', handlePointerMove);
        canvas.addEventListener('touchmove', handlePointerMove);
        document.addEventListener('mouseup', handlePointerUp);
        document.addEventListener('touchend', handlePointerUp);
        resetButton.addEventListener('click', handleReset);

        window.onload = () => {
            resizeCanvas();
            handleReset();
        };

    </script>
</body>
</html>
